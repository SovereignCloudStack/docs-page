"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9520],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>h});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=o.createContext({}),c=function(e){var t=o.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=c(e.components);return o.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},p=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),p=c(n),h=a,m=p["".concat(l,".").concat(h)]||p[h]||u[h]||i;return n?o.createElement(m,s(s({ref:t},d),{},{components:n})):o.createElement(m,s({ref:t},d))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,s=new Array(i);s[0]=p;var r={};for(var l in t)hasOwnProperty.call(t,l)&&(r[l]=t[l]);r.originalType=e,r.mdxType="string"==typeof e?e:a,s[1]=r;for(var c=2;c<i;c++)s[c]=n[c];return o.createElement.apply(null,s)}return o.createElement.apply(null,n)}p.displayName="MDXCreateElement"},72:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>c});var o=n(7462),a=(n(7294),n(3905));const i={title:"Requirements for SSO identity federation",type:"Decision Record",status:"Stable",stabilized_at:new Date("2023-06-21T00:00:00.000Z"),track:"IAM"},s=void 0,r={unversionedId:"active/scs-0300-v1-requirements-for-sso-identity-federation",id:"active/scs-0300-v1-requirements-for-sso-identity-federation",title:"Requirements for SSO identity federation",description:"Introduction",source:"@site/standards/active/scs-0300-v1-requirements-for-sso-identity-federation.md",sourceDirName:"active",slug:"/active/scs-0300-v1-requirements-for-sso-identity-federation",permalink:"/standards/active/scs-0300-v1-requirements-for-sso-identity-federation",draft:!1,tags:[],version:"current",frontMatter:{title:"Requirements for SSO identity federation",type:"Decision Record",status:"Stable",stabilized_at:"2023-06-21T00:00:00.000Z",track:"IAM"},sidebar:"standards",previous:{title:"SCS KaaS default storage class",permalink:"/standards/active/scs-0211-v1-kaas-default-storage-class"},next:{title:"Status Page create decision",permalink:"/standards/active/scs-0400-v1-status-page-create-decision"}},l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Motivation for this document",id:"motivation-for-this-document",level:2},{value:"Design Considerations",id:"design-considerations",level:2},{value:"Options considered",id:"options-considered",level:3},{value:"Keycloak",id:"keycloak",level:4},{value:"Zitadel",id:"zitadel",level:4},{value:"Open questions",id:"open-questions",level:2},{value:"Decision",id:"decision",level:2},{value:"Related Documents",id:"related-documents",level:2},{value:"Conformance Tests",id:"conformance-tests",level:2},{value:"Conformance Tests, OPTIONAL",id:"conformance-tests-optional",level:2}],d={toc:c};function u(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,o.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h2",{id:"introduction"},"Introduction"),(0,a.kt)("p",null,"Our assumption is that there are use cases, where CSPs would like to be able to\nlet customers access their SCS based services by identifying themselves with\ncredentials that are stored and managed external to the CSP's SCS installation."),(0,a.kt)("p",null,"This is based on the observation that prospective customers of an SCS based CSP\nsometimes already come equipped with an IAM solution of their choice, either on\npremises or e.g. as an external 3rd party cloud service. To ease onboarding of\ncustomer employees (or e.g. customer contracted 3rd party admin staff) as SCS\nusers, it would be good to be able to consume these external identities in SCS."),(0,a.kt)("p",null,"For customers this avoids the neccessity to explicitly maintain an additional\ndedicated account in SCS and this also reduces what SCS needs to do with\nrespect to taking care of persisting user account information."),(0,a.kt)("p",null,"To put it in other words, in SCS we would like to be able to delegate\nauthentication to external identity providers and map those users to roles in\nSCS that can be used for authorization decisions when users access SCS services."),(0,a.kt)("p",null,'In addition to user identities there we also see the necessity to support the\nuse of "machine identites" (aka "workload identities" or "service accounts").\nThese will probably be SCS-local accounts and have for example the purpose\nto grant CaaS workload access to storage resources served by the infrastructure\nlayer. Exact architectural details for this are still in active discussion,\nbut it is anticipated that the IdP component should be very useful in\nfacilitating the integration.'),(0,a.kt)("h2",{id:"motivation-for-this-document"},"Motivation for this document"),(0,a.kt)("p",null,"SCS has multiple service layers, like IaaS and CaaS, both of which running their\nown technological stack with specific internal models of accounts and\nauthorization."),(0,a.kt)("p",null,"One thing these services have in common, is that they are able\nto use SSO protocols like OAuth 2.0 or OpenID Connect (OIDC) on top of it to\ndelegate authentication. They are service providers (SAML terminology) and can\nbe relying parties (OIDC terminology) of a protocol compliant identity provider\n(IdP)."),(0,a.kt)("p",null,"So the idea is, to run an SSO IdP as part of SCS to provide a dedicated point\nof entry for identites, which the SCS service layers can use as a common\ninterface to consume external user identities."),(0,a.kt)("p",null,"The purpose of this document is to specify what requirements a specific\ntechnical IdP implementation (i.e. software solution) needs to fulfill\nin the context of SCS."),(0,a.kt)("h2",{id:"design-considerations"},"Design Considerations"),(0,a.kt)("p",null,"As a central service for identity handling, the IdP\nservice needs to be robust and reliable."),(0,a.kt)("p",null,'Customers shall be able to access self service, so that\nthey can make reasonable adjustments e.g. to role mapping.\nAt the time of writing this document it\'s still undecided\nif SCS has the requirement of a dedicated "self service" service\nthat serves as a frontend to provision and re-configure\ncustomer specific data, abstracting e.g. from IdP specific\nuser interface particularities.'),(0,a.kt)("p",null,'Keycloak is currently being deployed as part of the IaaS reference implementation.\nTechnically this IdP component shall be shifted from the management\nplane to be run on the basis of a "minimal" Kubernetes (e.g. K3S),\ne.g. to make use of the "self healing" and scaling features achievable\nwith that.'),(0,a.kt)("p",null,"So one of the considerations is if the solution will work well on a\nK8S environment. The instances will need to share configuration\n(probably via the shared backend database) as well as session state.\nMaybe one is better prepared for horizontal scaling than the other."),(0,a.kt)("h3",{id:"options-considered"},"Options considered"),(0,a.kt)("h4",{id:"keycloak"},"Keycloak"),(0,a.kt)("p",null,"Keycloak is a commonly used IdP solution implemented in Java.\nIt is developed as an open source community project.\nRed Hat uses it as upstream source for their Red Hat SSO product\nand is also listed as sponsor of the project.\nStarting with version 17 the default distribution is based on\nQuarkus instead of WildFly/JBoss."),(0,a.kt)("p",null,"The project maintains several means of community contributions\nas listed on the ",(0,a.kt)("a",{parentName:"p",href:"https://www.keycloak.org/community"},"community section"),"\nof the project website. It uses ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/keycloak/keycloak/issues"},"Github issues"),"\nto track development."),(0,a.kt)("p",null,"It offers a REST API for administration and there's a separately maintained\n3rd party python module as well as ansible support for it. Both of these are\ndownstream of Keycloak itself and may thus not always be feature complete and\nsuffer latency with respect to getting adjusted to upstream changes."),(0,a.kt)("p",null,'It offers support for commonly used SSO protocols and is "reasonably" fast\nin adopting to protocol standard changes and extensions. This has been\nobserved in the case of logout support (backend and frontend variants) in OIDC.'),(0,a.kt)("p",null,'It offers a concept of "Identity Brokering", where Keycloak is not just IdP\nbut also "client" to other IdPs. This allows daisy chaining of identity\nfederation. In this configuration it can work as a point of protocol\ntransition between different supported SSO protocols (SAML, OAuth 2.0, etc.).'),(0,a.kt)("p",null,"Beyond this capability of using other IdPs as identity sources, it also supports\nusing classic LDAP based IAM services as backend (OpenLDAP and Active Directory,\ne.g.)."),(0,a.kt)("p",null,'Keycloak\'s implementation makes some design decisions, that are specific\nto it and have consequences for clients of the service. E.g. Keycloak\nhas a concept of management "Realms", which have their own specific\nset of HTTP API entrypoints, both for administration as well as for IdP\nrequests.'),(0,a.kt)("p",null,'Commonly Keycloak realms can be used to map them 1:1 to user domains,\nbut since Keycloak supports configuring multiple backend IdPs in a\nrealm to be used for "Identity Brokering", there is always the\npossibility to create a kind of "proxy" realm to provide a single\nstandard set of HTTP API endpoints for SSO clients (service providers)\nto avoid the need to frequently extend/reduce client service configuration\nwhenever a new IdP federation needs to be added to Keycloak to onboard\na new customer. This is relevant for services like OpenStack Keystone,\nwhich currently cannot be easily reconfigured for new SSO endpoints\nwithout restarting the service, making the service unavailable for\na short span of time and increasing risk connected with service restarts.'),(0,a.kt)("p",null,'Since version 17, Keycloak claims that it\'s capability for\n"cloud native" deployments on Kubernetes has improved.'),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://www.keycloak.org/docs-api/20.0.1/rest-api/index.html"},"Keycloak is offering a REST API"),"\nfor all aspects of its administration interface."),(0,a.kt)("p",null,"For storage of Keycloak configuration and local user metadata\n(e.g. from which external IdP a user account originally came from)\nKeycloak supports several SQL backends through JDBC. Thus\nit can be hooked up to a Postgres Database or to a\nMariaDB/Galera cluster e.g.."),(0,a.kt)("p",null,"As of April 11, 2023, Keycloak joined the CNCF as an incubating project."),(0,a.kt)("h4",{id:"zitadel"},"Zitadel"),(0,a.kt)("p",null,"Zitadel is a newer implementation of an SSO IdP.\nIt is implemented in Go and under active development and maintained by ZITADEL."),(0,a.kt)("p",null,"The project is open for community ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/zitadel/zitadel/blob/main/CONTRIBUTING.md"},"contributions"),"\nto all parts of the eco system.\nFeature requests and bugs being tracked on ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/orgs/zitadel/projects/2/views/5"},"Github")," for development.\nCommunity questions can be asked in the ",(0,a.kt)("a",{parentName:"p",href:"https://zitadel.com/chat"},"public chat")," or via ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/zitadel/zitadel/discussions"},"Github Discussions"),".\nZITADEL offers support for the commonly used authentication and authorization protocols such as OIDC, OAuth2, SAML2.\nIt is a compliant and certified OpenID Connect provider with support for various Grant Types for both human users and machine users.\nCompared to Keycloak SPIs, ZITADEL offers Actions to customize and integrate (eg, calling external APIs, Webhooks, customizing pre-built workflows, customizing tokens)\nActions are executed at runtime and can be maintained independently of platform.\nIdentity brokering (OIDC, SAML, JWT) can be configured system-wide or for each organization with templates.\nUsers will be created just in time for audit purposes and linked to the external identity provider.\nUsers can have multiple identity providers linked to their profile."),(0,a.kt)("p",null,"It came to attention of the SCS project because it offers a\nfresh take of an organization focussed data model, which has\nthe potential to simplify IdP federation to SCS customer domains\nin the following areas:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"For client services (single set of HTTP API endpoints)."),(0,a.kt)("li",{parentName:"ul"},"For SCS operators for provisioning customer ",(0,a.kt)("a",{parentName:"li",href:"https://zitadel.com/docs/concepts/structure/organizations"},"organizations"),"\nand robust configuraton by using templated client, role and mapping\nconfiguration."),(0,a.kt)("li",{parentName:"ul"},"For SCS customers for a robust user experience for self servicing.")),(0,a.kt)("p",null,"The concept for ",(0,a.kt)("a",{parentName:"p",href:"https://zitadel.com/docs/concepts/structure/organizations"},"Delegated Access Management"),"\nreduces the management overhead compared to isolated realms.\nProjects (Applications + Roles) can be maintained by one organization and delegated to be used by other Organizations.\nManagers that receive granted Projects can assign users permissions to use the project."),(0,a.kt)("p",null,(0,a.kt)("a",{parentName:"p",href:"https://zitadel.com/docs/apis/introduction"},"Zitadel is offering REST APIs"),"\nfor multiple areas of use and configuration."),(0,a.kt)("p",null,"It recently also added support for the ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/zitadel/oidc/issues/141"},"Device Authorization Grant"),",\nwhich, at time of writing, is a feauture that is relevant\nfor SCS to be able use OpenStack CLI and APIs with federated\nidentities (",(0,a.kt)("a",{parentName:"p",href:"https://github.com/SovereignCloudStack/issues/issues/221"},"Device Authorization Grant"),")."),(0,a.kt)("p",null,"Support for consumption of LDAP backends is available since ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/zitadel/zitadel/releases/tag/v2.23.0"},"Zitadel v2.23.0"),"\n(see ",(0,a.kt)("a",{parentName:"p",href:"https://zitadel.com/docs/guides/integrate/identity-providers/ldap"},"this guide"),")."),(0,a.kt)("p",null,"ZITADEL supported backend databases are CockroachDB and PostgreSQL."),(0,a.kt)("p",null,"For ",(0,a.kt)("a",{parentName:"p",href:"https://zitadel.com/docs/self-hosting/manage/production"},"production setups")," it is recommended\nto use Kubernetes (or similar like Knative) and CockroachDB."),(0,a.kt)("p",null,'At time of writing a PoC "spike" is done to assess and verify the hopes\nconnected with Zitadel in the context of the SCS testbed.'),(0,a.kt)("p",null,"Currently Zitadel is lacking the possibility to easily add custom claims.\nIt supports ",(0,a.kt)("inlineCode",{parentName:"p"},"urn:zitadel:iam:user:metadata"),", but that is more suitable\ntowards Kubernetes and cannot be parsed with the OpenStack mapping mechanism.\n",(0,a.kt)("a",{parentName:"p",href:"https://github.com/zitadel/zitadel/issues/3997"},"There is work going on")," which\nmay be suitable to resolve this issue.\nAn approach based on Zitadel actions is also currently evaluated.\nOpenStack currently makes use of custom claims to pass ",(0,a.kt)("inlineCode",{parentName:"p"},"openstack-default-project"),"\nfrom the IdP to OpenStack. Combined with federation to external customer managed IdPs\nthis should allow customers to manage settings like these in their own IAM."),(0,a.kt)("h2",{id:"open-questions"},"Open questions"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"How would we implement testbed deployment support for Zitadel?",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"e.g. ",(0,a.kt)("inlineCode",{parentName:"li"},"wsgi-keystone.conf")," would need to look different. One template covering both options?"),(0,a.kt)("li",{parentName:"ul"},"e.g. steps like ",(0,a.kt)("inlineCode",{parentName:"li"},"openstack federation protocol create")," would probably be different."))),(0,a.kt)("li",{parentName:"ul"},"Should we support both as options?",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"What's the benefit?"),(0,a.kt)("li",{parentName:"ul"},"How would we allow SCS operators to choose?"))),(0,a.kt)("li",{parentName:"ul"},"Do we need some kind of SWOT analysis to come to a decision?")),(0,a.kt)("h2",{id:"decision"},"Decision"),(0,a.kt)("p",null,"SCS wants to make use of an IdP as part of the reference implementation.\nTo move forward with topics of configuration and mapping of roles in a\nOAuth2 federation scenario as well as questions of token lifecycles etc. across\nthe federation stack it makes sense to focus on one IdP implementation at a\ngiven time. Both considered options seem to be potentially viable, but ultimately,\na decision should be made, even if there are no strict/strong reasons for\ndismissing either option in particular."),(0,a.kt)("p",null,"The project's current choice is Keycloak for the following reasons:\nKeycloak currently supports the OAuth 2.0 grants that SCS wants to make\nuse of (e.g. Device Authorization Grant). It is the implementation for\nwhich integration is currently documented in OpenStack and implemented\nin kolla-ansible. SCS currently deploys Keycloak and the IAM team has\nmost hands on expecience with it, e.g. when it comes to colletaral questions\nlike how to make TLS and signing certificates available to the IdP that shall\nbe used in federation to external domains."),(0,a.kt)("h2",{id:"related-documents"},"Related Documents"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://github.com/SovereignCloudStack/standards/tree/main/Drafts/IAM-federation"},"https://github.com/SovereignCloudStack/standards/tree/main/Drafts/IAM-federation"))),(0,a.kt)("h2",{id:"conformance-tests"},"Conformance Tests"),(0,a.kt)("h2",{id:"conformance-tests-optional"},"Conformance Tests, OPTIONAL"))}u.isMDXComponent=!0}}]);