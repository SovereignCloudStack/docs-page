"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[9719],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),c=p(n),m=r,h=c["".concat(s,".").concat(m)]||c[m]||d[m]||o;return n?a.createElement(h,l(l({ref:t},u),{},{components:n})):a.createElement(h,l({ref:t},u))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=c;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var p=2;p<o;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8819:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var a=n(7462),r=(n(7294),n(3905));const o={title:"SCS k8s-cluster-api-provider upgrade guide",version:new Date("2023-03-16T00:00:00.000Z"),authors:"Kurt Garloff, Roman Hros, Matej Feder",state:"Draft (v0.6)"},l=void 0,i={unversionedId:"container/components/k8s-cluster-api-provider/doc/Upgrade-Guide",id:"container/components/k8s-cluster-api-provider/doc/Upgrade-Guide",title:"SCS k8s-cluster-api-provider upgrade guide",description:"SCS k8s-cluster-api-provider upgrade guide",source:"@site/docs/03-container/components/k8s-cluster-api-provider/doc/Upgrade-Guide.md",sourceDirName:"03-container/components/k8s-cluster-api-provider/doc",slug:"/container/components/k8s-cluster-api-provider/doc/Upgrade-Guide",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/Upgrade-Guide",draft:!1,editUrl:"https://github.com/SovereignCloudStack/docs-page/tree/main/docs/03-container/components/k8s-cluster-api-provider/doc/Upgrade-Guide.md",tags:[],version:"current",frontMatter:{title:"SCS k8s-cluster-api-provider upgrade guide",version:"2023-03-16T00:00:00.000Z",authors:"Kurt Garloff, Roman Hros, Matej Feder",state:"Draft (v0.6)"},sidebar:"docs",previous:{title:"Why externalTrafficPolicy: local?",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/LoadBalancer-ExtTrafficLocal"},next:{title:"Roadmap",permalink:"/docs/container/components/k8s-cluster-api-provider/doc/roadmap"}},s={},p=[{value:"SCS k8s-cluster-api-provider upgrade guide",id:"scs-k8s-cluster-api-provider-upgrade-guide",level:2},{value:"Management host (cluster) vs. Workload clusters",id:"management-host-cluster-vs-workload-clusters",level:2},{value:"Updating the management host",id:"updating-the-management-host",level:2},{value:"In-place upgrade",id:"in-place-upgrade",level:3},{value:"Operating system",id:"operating-system",level:4},{value:"k8s-cluster-api-provider git",id:"k8s-cluster-api-provider-git",level:4},{value:"Updating cluster-API and openstack cluster-API provider",id:"updating-cluster-api-and-openstack-cluster-api-provider",level:4},{value:"New templates",id:"new-templates",level:4},{value:"R4 to R5",id:"r4-to-r5",level:5},{value:"New defaults",id:"new-defaults",level:4},{value:"The clusterctl move approach",id:"the-clusterctl-move-approach",level:3},{value:"Updating workload clusters",id:"updating-workload-clusters",level:2},{value:"k8s version upgrade",id:"k8s-version-upgrade",level:3},{value:"On R3 and R4 clusters",id:"on-r3-and-r4-clusters",level:4},{value:"On R2 clusters",id:"on-r2-clusters",level:4},{value:"New versions for mandatory components",id:"new-versions-for-mandatory-components",level:3},{value:"New versions for optional components",id:"new-versions-for-optional-components",level:3},{value:"etcd leader changes",id:"etcd-leader-changes",level:3}],u={toc:p};function d(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"scs-k8s-cluster-api-provider-upgrade-guide"},"SCS k8s-cluster-api-provider upgrade guide"),(0,r.kt)("p",null,"This document explains the steps to upgrade the SCS Kubernetes cluster-API\nbased cluster management solution as follows:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"from the R2 (2022-03) to the R3 (2022-09) state"),(0,r.kt)("li",{parentName:"ul"},"from the R3 (2022-09) to the R4 state\nThe document explains how the management cluster and the workload clusters can be\nupgraded without disruption. It is highly recommended to do a step-by-step upgrade\nacross major releases i.e. upgrade from R2 to R3 and then to R4 in the case of\nupgrade from the R2 to the R4. Upgrades across major releases without step-by-step\nprocess is not recommended and could lead to undocumented issues.")),(0,r.kt)("p",null,"The various steps are not very complicated, but there are numerous steps to\ntake, and it is advisable that cluster operators get some experience with\nthis kind of cluster management before applying this to customer clusters\nthat carry important workloads."),(0,r.kt)("p",null,"Note that while the detailed steps are tested and targeted to a R2 -> R3 move or\nR3 -> R4 move, many of the steps are a generic approach that will apply also for other\nupgrades, so expect a lot of similar steps when moving beyond R4.\nUpgrades from cluster management prior to R2 is difficult; many changes before\nR2 assumed that you would redeploy the management cluster. Redeploying the\nmanagement cluster can of course always be done, but it's typically disruptive\nto your workload clusters, unless you move your cluster management state into\na new management cluster with ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl move"),"."),(0,r.kt)("h2",{id:"management-host-cluster-vs-workload-clusters"},"Management host (cluster) vs. Workload clusters"),(0,r.kt)("p",null,"When you initially deployed the SCS k8s-cluster-api-provider, you create a\nVM with a ",(0,r.kt)("a",{parentName:"p",href:"https://kind.sigs.k8s.io/"},"kind")," cluster inside and a number of\ntemplates, scripts and binaries that are then used to do the cluster management.\nThis is your management host (or more precisely you single-host management\ncluster). Currently, all cluster management including upgrading etc. is done\nby connecting to this host via ssh and performing commands there. (You don't\nneed root privileges to do cluster management there, the normal ubuntu user\nrights are sufficient; there are obviously host management tasks such as\ninstalling package updates that do require root power and the user has the\nsudo rights to do so.)"),(0,r.kt)("p",null,"When you create the management host, you have the option to create your\nfirst workload cluster. This cluster is no different from other workload\nclusters that you create by calling commands on the management host, so you\ncan manage it there. (The default name of this cluster is typically\n",(0,r.kt)("inlineCode",{parentName:"p"},"testcluster"),", though that can be changed since a while, #264)."),(0,r.kt)("p",null,"On the management host, you have the openstack and kubernetes tools\ninstalled and configured, so you can nicely manage all aspects of your\nCaaS setups as well as the underlying IaaS. The kubectl configuration\nis in ",(0,r.kt)("inlineCode",{parentName:"p"},"~/.kube/config")," while you will find the OpenStack configuration\nin ",(0,r.kt)("inlineCode",{parentName:"p"},"~/.config/openstack/clouds.yaml"),". These files are automatically\nmanaged; you can add entries to the files though, and they should\npersist."),(0,r.kt)("h2",{id:"updating-the-management-host"},"Updating the management host"),(0,r.kt)("p",null,"There are two different possibilities to upgrade the management host."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"You do a component-wise in-place upgrade of it."),(0,r.kt)("li",{parentName:"ol"},"You deploy a new management host and ",(0,r.kt)("inlineCode",{parentName:"li"},"clusterctl move")," the resources\nover to it from the old one. (Note: Config state in ",(0,r.kt)("inlineCode",{parentName:"li"},"~/CLUSTER_NAME/"),")")),(0,r.kt)("p",null,"TODO: Advice when to do what, risks, limitations"),(0,r.kt)("h3",{id:"in-place-upgrade"},"In-place upgrade"),(0,r.kt)("h4",{id:"operating-system"},"Operating system"),(0,r.kt)("p",null,"You should keep the host up-to-date with respect to normal operating system\nupgrades, so perform your normal ",(0,r.kt)("inlineCode",{parentName:"p"},"sudo apt-get update && sudo apt-get upgrade"),".\n",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"kustomize"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"yq"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"lxd")," and a few other tools are installed as\nsnaps, so you may want to upgrade these as well: ",(0,r.kt)("inlineCode",{parentName:"p"},"sudo snap refresh"),".\nDefault operating system image was changed from Ubuntu 20.04 to Ubuntu 22.04 in R4."),(0,r.kt)("h4",{id:"k8s-cluster-api-provider-git"},"k8s-cluster-api-provider git"),(0,r.kt)("p",null,"The automation is deployed on the management host by cloning ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/SovereignCloudStack/k8s-cluster-api-provider"},"the relevant\ngit repository"),".\ninto the ",(0,r.kt)("inlineCode",{parentName:"p"},"k8s-cluster-api-provider")," directory. Note that the checked out\nbranch will be the one that has been used when creating the management host\nand you might want to change branches from ",(0,r.kt)("inlineCode",{parentName:"p"},"maintained/v3.x")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"maintained/v4.x"),"\nin case of R2 to R3 upgrade, or ",(0,r.kt)("inlineCode",{parentName:"p"},"maintained/v5.x")," for R3 to R4 upgrade.\nUse ",(0,r.kt)("inlineCode",{parentName:"p"},"git branch -rl")," to see available branches in the k8s-cluster-api-provider\nrepository."),(0,r.kt)("p",null,"You can update the scripts and templates by checking out the relevant branch\n",(0,r.kt)("inlineCode",{parentName:"p"},"main"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"maintained/v4.x")," or ",(0,r.kt)("inlineCode",{parentName:"p"},"maintained/v5.x")," and using a ",(0,r.kt)("inlineCode",{parentName:"p"},"git pull")," to ensure\nthe latest content is retrieved. Once you do that, the cluster-management scripts\nwill be up-to-date. (The ",(0,r.kt)("inlineCode",{parentName:"p"},"~/bin")," directory in your search ",(0,r.kt)("inlineCode",{parentName:"p"},"PATH")," is symlinked to the\ncheck-ed out scripts.)"),(0,r.kt)("p",null,"Note however that the binaries and used templates are NOT automatically updated.\nThis should not normally result in problems -- when new features are introduced\nin the management scripts, they ensure to continue to support older templates."),(0,r.kt)("h4",{id:"updating-cluster-api-and-openstack-cluster-api-provider"},"Updating cluster-API and openstack cluster-API provider"),(0,r.kt)("p",null,"To get the latest version of cluster-API, you can download a new clusterctl\nbinary from ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/kubernetes-sigs/cluster-api/releases"},"https://github.com/kubernetes-sigs/cluster-api/releases"),",\nmake it executable ",(0,r.kt)("inlineCode",{parentName:"p"},"chmod +x clusterctl")," and install it to ",(0,r.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/"),",\npossibly saving the old binary by renaming it. ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl version")," should now\ndisplay the current version number (v1.3.5 at the time of this writing)."),(0,r.kt)("p",null,"You can now issue the command ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl upgrade plan")," and clusterctl will\nlist the components in your (kind) management cluster that can be upgraded.\nHere's an example output:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'ubuntu@capi-old-mgmtcluster:~ [0]$ clusterctl upgrade plan\nChecking cert-manager version...\nCert-Manager will be upgraded from "v1.9.1" to "v1.11.0"\n\nChecking new release availability...\n\nLatest release available for the v1beta1 API Version of Cluster API (contract):\n\nNAME                       NAMESPACE                           TYPE                     CURRENT VERSION   NEXT VERSION\nbootstrap-kubeadm          capi-kubeadm-bootstrap-system       BootstrapProvider        v1.2.4            v1.3.5\ncontrol-plane-kubeadm      capi-kubeadm-control-plane-system   ControlPlaneProvider     v1.2.4            v1.3.5\ncluster-api                capi-system                         CoreProvider             v1.2.4            v1.3.5\ninfrastructure-openstack   capo-system                         InfrastructureProvider   v0.6.3            v0.7.1\n\nYou can now apply the upgrade by executing the following command:\n\nclusterctl upgrade apply --contract v1beta1\n')),(0,r.kt)("p",null,"You can then upgrade the components. You can do them one-by-one or simply do\n",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl upgrade apply --contract v1beta1")),(0,r.kt)("h4",{id:"new-templates"},"New templates"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," template used for the workload clusters is located in\n",(0,r.kt)("inlineCode",{parentName:"p"},"~/k8s-cluster-api-provider/terraform/files/template/")," and copied from there into\n",(0,r.kt)("inlineCode",{parentName:"p"},"~/cluster-defaults/"),". Then workload clusters are created, they will also have a\ncopy of it in ",(0,r.kt)("inlineCode",{parentName:"p"},"~/${CLUSTER_NAME}/"),". If you have not changed it manually, you can\ncopy it over the old templates. (Consider backing up the old one though.)"),(0,r.kt)("p",null,"The next ",(0,r.kt)("inlineCode",{parentName:"p"},"create_cluster.sh <CLUSTER_NAME>")," run will then use the new template.\nNote that ",(0,r.kt)("inlineCode",{parentName:"p"},"create_cluster.sh")," is idempotent -- it will not perform any changes\non the cluster unless you have changed its configuration by tweaking\n",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," (which you almost never do!) or ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl.yaml"),"\n(which you do often)."),(0,r.kt)("p",null,"The other template file that changed -- however, some terraform logic is used to\nprefill it with values. So you can't copy it from git.\nInstead for going from R2 to R3, there is just one real change that you want\nto apply: Add the variables ",(0,r.kt)("inlineCode",{parentName:"p"},"CONTROL_PLANE_MACHINE_GEN: genc01")," and\n",(0,r.kt)("inlineCode",{parentName:"p"},"WORKER_MACHINE_GEN: genw01")," to it. If you have copied over the new\n",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," as described above, then you're done. Otherwise\nyou can use the script ",(0,r.kt)("inlineCode",{parentName:"p"},"update-R2-R3.sh <CLUSTER_NAME>"),"\nto tweak both ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl.yaml")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," for the\nrelevant cluster. (You can use ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-defaults")," to change the templates\nin ",(0,r.kt)("inlineCode",{parentName:"p"},"~/cluster-defaults/")," which get used when creating new clusters.)"),(0,r.kt)("p",null,"In the R3 to R4, CALICO_VERSION was moved from ",(0,r.kt)("inlineCode",{parentName:"p"},".capi-settings")," to ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl.yaml"),". So\nbefore upgrading workload clusters, you must add it also to the ",(0,r.kt)("inlineCode",{parentName:"p"},"~/${CLUSTER_NAME}/clusterctl.yaml"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'echo "CALICO_VERSION: v3.25.0" >> ~/cluster-defaults/clusterctl.yaml\necho "CALICO_VERSION: v3.25.0" >> ~/testcluster/clusterctl.yaml\n')),(0,r.kt)("p",null,"In the R3 to R4 upgrade process, ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," changed etcd defrag process in the\nkubeadm control-planes and also security group names by adding ",(0,r.kt)("inlineCode",{parentName:"p"},"${PREFIX}-")," to them, so it\nhas to be changed also in openstack project e.g. (",(0,r.kt)("em",{parentName:"p"},"PREFIX=capi"),"):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"openstack security group set --name capi-allow-ssh allow-ssh\nopenstack security group set --name capi-allow-icmp allow-icmp\n")),(0,r.kt)("p",null,"We changed immutable fields in the Cluster API templates, so before running\n",(0,r.kt)("inlineCode",{parentName:"p"},"create_cluster.sh")," to upgrade existing workload cluster the ",(0,r.kt)("inlineCode",{parentName:"p"},"CONTROL_PLANE_MACHINE_GEN"),"\nand ",(0,r.kt)("inlineCode",{parentName:"p"},"WORKER_MACHINE_GEN")," needs to be incremented in cluster specific ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl.yaml"),"."),(0,r.kt)("p",null,"In the R3 to R4 process, also ",(0,r.kt)("inlineCode",{parentName:"p"},"cloud.conf")," added ",(0,r.kt)("inlineCode",{parentName:"p"},"enable-ingress-hostname=true")," to the\nLoadBalancer section. It is due to ",(0,r.kt)("inlineCode",{parentName:"p"},"NGINX_INGRESS_PROXY")," defaulting to true now. So if\nyou want to use, or you are already using this proxy functionality we recommend you to\nadd this line to your ",(0,r.kt)("inlineCode",{parentName:"p"},"cloud.conf"),", e.g.:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'echo "enable-ingress-hostname=true" >> ~/cluster-defaults/cloud.conf\necho "enable-ingress-hostname=true" >> ~/testcluster/cloud.conf\n')),(0,r.kt)("p",null,"Then, before upgrading workload cluster by ",(0,r.kt)("inlineCode",{parentName:"p"},"create_cluster.sh"),",\nyou should delete cloud-config secret in the kube-system namespace, so it can be recreated. E.g.:\n",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl delete secret cloud-config -n kube-system --kubeconfig=testcluster/testcluster.yaml")),(0,r.kt)("p",null,"Also, the default nginx-ingress version has changed, so we recommend before upgrading cluster\nto delete ingress-nginx jobs, so new job with new image can be created in the update process."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl delete job ingress-nginx-admission-create -n ingress-nginx --kubeconfig=testcluster/testcluster.yaml\nkubectl delete job ingress-nginx-admission-patch -n ingress-nginx --kubeconfig=testcluster/testcluster.yaml\n")),(0,r.kt)("p",null,"If you are curious: In R2, doing rolling upgrades of k8s versions required\nedits in ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," -- this is no longer the case in R3 and R4.\nJust increase the generation counter for node and control plane nodes if you\nupgrade k8s versions -- or otherwise change the worker or control plane\nnode specs, such as e.g. using a different flavor."),(0,r.kt)("h5",{id:"r4-to-r5"},"R4 to R5"),(0,r.kt)("p",null,"In R4 to R5, the ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl.yaml")," changed (see release notes)."),(0,r.kt)("p",null,"You can use script ",(0,r.kt)("inlineCode",{parentName:"p"},"update_R4_to_R5.sh")," to update the default ",(0,r.kt)("inlineCode",{parentName:"p"},"cluster-template.yaml")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl.yaml"),"."),(0,r.kt)("p",null,"Note: !This script is under development and will be stabilized within the release R5!"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"update_R4_to_R5.sh <CLUSTER_NAME>\n")),(0,r.kt)("h4",{id:"new-defaults"},"New defaults"),(0,r.kt)("p",null,"You deploy a CNI (calico or cilium), the OpenStack Cloud Controller\nManager (OCCM), the cinder CSI driver to clusters; optionally also a\nmetrics server (default is true), a nginx ingress controller (also\ndefaulting to true), the flux2 controller, the cert-manager.\nSome of these tools come with binaries that you can use for management\npurposes and which get installed on the management host in ",(0,r.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/"),"."),(0,r.kt)("p",null,"The scripts that deploy these components into your workload clusters\ndownload the manifests into ",(0,r.kt)("inlineCode",{parentName:"p"},"~/kubernetes-manifests.d/")," with a version\nspecific name. If you request a new version, a new download will happen;\nalready existing versions will not be re-downloaded."),(0,r.kt)("p",null,"Most binaries in ",(0,r.kt)("inlineCode",{parentName:"p"},"/usr/local/bin/")," are not stored under a version-specific\nname. You need to rename them to case a re-download of a newer version.\n(The reason for not having version specific names is that this would\nbreak scripts from users that assume the unversioned names; the good\nnews is that most of these binaries have no trouble managing somewhat\nolder deployments, so you can typically work with the latest binary\ntool even if you have a variety of versions deployed into various\nclusters.)"),(0,r.kt)("p",null,"The defaults have changed as follows:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null}),(0,r.kt)("th",{parentName:"tr",align:null},"R2"),(0,r.kt)("th",{parentName:"tr",align:null},"R3"),(0,r.kt)("th",{parentName:"tr",align:null},"R4"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"kind"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.14.0"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.14.0"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.17.0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"capi"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.0.5"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.2.2"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.3.5")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"capo"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.5.3"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.6.3"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.7.1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"helm"),(0,r.kt)("td",{parentName:"tr",align:null},"v3.8.1"),(0,r.kt)("td",{parentName:"tr",align:null},"v3.9.4"),(0,r.kt)("td",{parentName:"tr",align:null},"v3.11.1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"sonobuoy"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.56.2"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.56.10"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.56.16")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"calico"),(0,r.kt)("td",{parentName:"tr",align:null},"v3.22.1"),(0,r.kt)("td",{parentName:"tr",align:null},"v3.24.1"),(0,r.kt)("td",{parentName:"tr",align:null},"v3.25.0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"cilium"),(0,r.kt)("td",{parentName:"tr",align:null},"unversioned"),(0,r.kt)("td",{parentName:"tr",align:null},"unversioned"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.13.0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"nginx-ingress"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.1.2"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.3.0"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.6.4")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"flux2"),(0,r.kt)("td",{parentName:"tr",align:null},"unversioned"),(0,r.kt)("td",{parentName:"tr",align:null},"unversioned"),(0,r.kt)("td",{parentName:"tr",align:null},"v0.40.2")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"cert-manager"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.7.1"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.9.1"),(0,r.kt)("td",{parentName:"tr",align:null},"v1.11.0")))),(0,r.kt)("p",null,"TODO: calico und cilium tooling note"),(0,r.kt)("h3",{id:"the-clusterctl-move-approach"},"The clusterctl move approach"),(0,r.kt)("p",null,"To be written"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create new management host in same project -- avoid name conflicts\nwith different prefix, to be tweaked later. Avoid testcluster creation"),(0,r.kt)("li",{parentName:"ol"},"Ensure it's up and running ..."),(0,r.kt)("li",{parentName:"ol"},"Tweak prefix"),(0,r.kt)("li",{parentName:"ol"},"Copy over configs (and a bit of state though that's uncritical) by using\nthe directories"),(0,r.kt)("li",{parentName:"ol"},"Copy over the openstack credentials clouds.yaml and the kubectl config"),(0,r.kt)("li",{parentName:"ol"},"clusterctl move")),(0,r.kt)("h2",{id:"updating-workload-clusters"},"Updating workload clusters"),(0,r.kt)("h3",{id:"k8s-version-upgrade"},"k8s version upgrade"),(0,r.kt)("h4",{id:"on-r3-and-r4-clusters"},"On R3 and R4 clusters"),(0,r.kt)("p",null,"Edit ",(0,r.kt)("inlineCode",{parentName:"p"},"~/<CLUSTER_NAME>/clusterctl.yaml")," and put the wanted version into the\nfields ",(0,r.kt)("inlineCode",{parentName:"p"},"KUBERNETES_VERSION")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"OPENSTACK_IMAGE_NAME"),". The node image will\nbe downloaded from ",(0,r.kt)("a",{parentName:"p",href:"https://minio.services.osism.tech/openstack-k8s-capi-images"},"https://minio.services.osism.tech/openstack-k8s-capi-images"),"\nand registered if needed. (If you have updated the k8s-cluster-api-provider repo,\nyou can use a version v1.NN.x, where you fill in NN with the wanted k8s version,\nbut leave a literal ",(0,r.kt)("inlineCode",{parentName:"p"},".x")," which will get translated to the newest tested version.)"),(0,r.kt)("p",null,"In the same file, increase the generation counters for ",(0,r.kt)("inlineCode",{parentName:"p"},"CONTROL_PLANE_MACHINE_GEN"),"\nand ",(0,r.kt)("inlineCode",{parentName:"p"},"WORKER_MACHINE_GEN"),"."),(0,r.kt)("p",null,"Now do the normal ",(0,r.kt)("inlineCode",{parentName:"p"},"create_cluster.sh <CLUSTER_NAME>")," and watch cluster-api\nreplace your worker nodes and doing a rolling upgrade of your control plane.\nIf you used a 3-node (or 5 or higher) control plane node setup, you will have\nuninterrupted access not just to your workloads but also the workload's cluster\ncontrol plane. Use ",(0,r.kt)("inlineCode",{parentName:"p"},"clusterctl describe cluster <CLUSTER_NAME>")," or simply\n",(0,r.kt)("inlineCode",{parentName:"p"},"kubectl --context <CLUSTER_NAME>-admin@<CLUSTER_NAME> get nodes -o wide"),"\nto watch the progress of this."),(0,r.kt)("h4",{id:"on-r2-clusters"},"On R2 clusters"),(0,r.kt)("p",null,"The old way: Editing cluster-template.yaml. Or better use the\n",(0,r.kt)("inlineCode",{parentName:"p"},"update-R2-to-R3.sh")," script to convert first."),(0,r.kt)("h3",{id:"new-versions-for-mandatory-components"},"New versions for mandatory components"),(0,r.kt)("p",null,"OCCM, CNI (calico/cilium), CSI"),(0,r.kt)("h3",{id:"new-versions-for-optional-components"},"New versions for optional components"),(0,r.kt)("p",null,"nginx, metrics (nothing to do), cert-manager, flux"),(0,r.kt)("h3",{id:"etcd-leader-changes"},"etcd leader changes"),(0,r.kt)("p",null,"While testing clusters with >= 3 control nodes, we have observed occasional transient\nerror messages that reported an etcd leader change preventing a command from succeeding.\nThis could result in a dozen of random failed tests in a sonobuoy conformance run.\n(Retrying the commands would let them succeed.)"),(0,r.kt)("p",null,"Too frequent etcd leader changes are detrimental to your control plane performance and\ncan lead to transient failures. They are a sign that the infrastructure supporting your\ncluster is introducing too high latencies."),(0,r.kt)("p",null,"We recommend to deploy the control nodes (which run etcd) on instances with local SSD\nstorage (which we reflect in the default flavor name) and recommend using flavors with\ndedicated cores and that your network does not introduce latencies by significant packet drop."),(0,r.kt)("p",null,"We now always use slower heartbeat (250ms) and increase CPU and IO priority which used to be\ncontrolled by ",(0,r.kt)("inlineCode",{parentName:"p"},"ETCD_PRIO_BOOST"),". This is safe."),(0,r.kt)("p",null,"If you build multi-controller clusters and can not use a flavor with low latency local storage\n(ideally SSD), you can also work around this with ",(0,r.kt)("inlineCode",{parentName:"p"},"ETCD_UNSAFE_FS"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"ETCD_UNSAFE_FS")," is using\n",(0,r.kt)("inlineCode",{parentName:"p"},"barrier=0")," mount option, which violates filesystem ordering guarantees.\nThis works around storage latencies, but introduces the risk of inconsistent\nfilesystem state and inconsistent etcd data in case of an unclean shutdown.\nYou may be able to live with this risk in a multi-controller etcd setup.\nIf you don't have flavors that fulfill the requirements (low-latency\nstorage attached), your choice is between a single-controller cluster\n(without ",(0,r.kt)("inlineCode",{parentName:"p"},"ETCD_UNSAFE_FS"),") and a multi-controller cluster with\n",(0,r.kt)("inlineCode",{parentName:"p"},"ETCD_UNSAFE_FS"),". Neither option is perfect, but we deem the\nmulti-controller cluster preferable in such a scenario."))}d.isMDXComponent=!0}}]);