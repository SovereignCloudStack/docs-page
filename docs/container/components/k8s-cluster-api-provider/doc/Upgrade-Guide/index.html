<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-container/components/k8s-cluster-api-provider/doc/Upgrade-Guide">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">SCS k8s-cluster-api-provider upgrade guide | One platform — standardized, built and operated by many.</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.scs.community/img/summit-social.png"><meta data-rh="true" name="twitter:image" content="https://docs.scs.community/img/summit-social.png"><meta data-rh="true" property="og:url" content="https://docs.scs.community/docs/container/components/k8s-cluster-api-provider/doc/Upgrade-Guide"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="SCS k8s-cluster-api-provider upgrade guide | One platform — standardized, built and operated by many."><meta data-rh="true" name="description" content="SCS k8s-cluster-api-provider upgrade guide"><meta data-rh="true" property="og:description" content="SCS k8s-cluster-api-provider upgrade guide"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.scs.community/docs/container/components/k8s-cluster-api-provider/doc/Upgrade-Guide"><link data-rh="true" rel="alternate" href="https://docs.scs.community/docs/container/components/k8s-cluster-api-provider/doc/Upgrade-Guide" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.scs.community/docs/container/components/k8s-cluster-api-provider/doc/Upgrade-Guide" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="One platform — standardized, built and operated by many. RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="One platform — standardized, built and operated by many. Atom Feed">






<link rel="preconnect" href="https://matomo.scs.community/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setDocumentTitle",document.domain+"/"+document.title]),_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="https://matomo.scs.community/";_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","2"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script><link rel="stylesheet" href="/assets/css/styles.e9349ca9.css">
<link rel="preload" href="/assets/js/runtime~main.fe345add.js" as="script">
<link rel="preload" href="/assets/js/main.150bd3f2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="SCS" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="SCS" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs">Docs</a><a class="navbar__item navbar__link" href="/standards">Standards</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/docs/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/SovereignCloudStack/docs-page" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/iaas-layer">IaaS Layer</a><button aria-label="Toggle the collapsible sidebar category &#x27;IaaS Layer&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/container-layer">Container Layer</a><button aria-label="Toggle the collapsible sidebar category &#x27;Container Layer&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/components-1">Components</a><button aria-label="Toggle the collapsible sidebar category &#x27;Components&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/category/k8s-cluster-api-provider">K8s Cluster API Provider</a><button aria-label="Toggle the collapsible sidebar category &#x27;K8s Cluster API Provider&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/requirements">Requirements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/quickstart">Quickstart</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/make-reference">Makefile reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/application-credentials">Application Credentials</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/configuration">Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/Maintenance_and_Troubleshooting">Maintenance and Troubleshooting Guide for SCS k8s-cluster-api-provider</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/LoadBalancer-ExtTrafficLocal">Why externalTrafficPolicy: local?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/Upgrade-Guide">SCS k8s-cluster-api-provider upgrade guide</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/roadmap">Roadmap</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-4 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/container/components/k8s-cluster-api-provider/doc/usage/">Usage</a></div></li></ul></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/operating-scs">Operating SCS</a><button aria-label="Toggle the collapsible sidebar category &#x27;Operating SCS&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/releases">Releases</a><button aria-label="Toggle the collapsible sidebar category &#x27;Releases&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq/">FAQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/glossary">Glossary</a></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/container-layer"><span itemprop="name">Container Layer</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/components-1"><span itemprop="name">Components</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/k8s-cluster-api-provider"><span itemprop="name">K8s Cluster API Provider</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">SCS k8s-cluster-api-provider upgrade guide</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>SCS k8s-cluster-api-provider upgrade guide</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="scs-k8s-cluster-api-provider-upgrade-guide">SCS k8s-cluster-api-provider upgrade guide<a href="#scs-k8s-cluster-api-provider-upgrade-guide" class="hash-link" aria-label="Direct link to SCS k8s-cluster-api-provider upgrade guide" title="Direct link to SCS k8s-cluster-api-provider upgrade guide">​</a></h2><p>This document explains the steps to upgrade the SCS Kubernetes cluster-API
based cluster management solution as follows:</p><ul><li>from the R2 (2022-03) to the R3 (2022-09) state</li><li>from the R3 (2022-09) to the R4 state
The document explains how the management cluster and the workload clusters can be
upgraded without disruption. It is highly recommended to do a step-by-step upgrade
across major releases i.e. upgrade from R2 to R3 and then to R4 in the case of
upgrade from the R2 to the R4. Upgrades across major releases without step-by-step
process is not recommended and could lead to undocumented issues.</li></ul><p>The various steps are not very complicated, but there are numerous steps to
take, and it is advisable that cluster operators get some experience with
this kind of cluster management before applying this to customer clusters
that carry important workloads.</p><p>Note that while the detailed steps are tested and targeted to a R2 -&gt; R3 move or
R3 -&gt; R4 move, many of the steps are a generic approach that will apply also for other
upgrades, so expect a lot of similar steps when moving beyond R4.
Upgrades from cluster management prior to R2 is difficult; many changes before
R2 assumed that you would redeploy the management cluster. Redeploying the
management cluster can of course always be done, but it&#x27;s typically disruptive
to your workload clusters, unless you move your cluster management state into
a new management cluster with <code>clusterctl move</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="management-host-cluster-vs-workload-clusters">Management host (cluster) vs. Workload clusters<a href="#management-host-cluster-vs-workload-clusters" class="hash-link" aria-label="Direct link to Management host (cluster) vs. Workload clusters" title="Direct link to Management host (cluster) vs. Workload clusters">​</a></h2><p>When you initially deployed the SCS k8s-cluster-api-provider, you create a
VM with a <a href="https://kind.sigs.k8s.io/" target="_blank" rel="noopener noreferrer">kind</a> cluster inside and a number of
templates, scripts and binaries that are then used to do the cluster management.
This is your management host (or more precisely you single-host management
cluster). Currently, all cluster management including upgrading etc. is done
by connecting to this host via ssh and performing commands there. (You don&#x27;t
need root privileges to do cluster management there, the normal ubuntu user
rights are sufficient; there are obviously host management tasks such as
installing package updates that do require root power and the user has the
sudo rights to do so.)</p><p>When you create the management host, you have the option to create your
first workload cluster. This cluster is no different from other workload
clusters that you create by calling commands on the management host, so you
can manage it there. (The default name of this cluster is typically
<code>testcluster</code>, though that can be changed since a while, #264).</p><p>On the management host, you have the openstack and kubernetes tools
installed and configured, so you can nicely manage all aspects of your
CaaS setups as well as the underlying IaaS. The kubectl configuration
is in <code>~/.kube/config</code> while you will find the OpenStack configuration
in <code>~/.config/openstack/clouds.yaml</code>. These files are automatically
managed; you can add entries to the files though, and they should
persist.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="updating-the-management-host">Updating the management host<a href="#updating-the-management-host" class="hash-link" aria-label="Direct link to Updating the management host" title="Direct link to Updating the management host">​</a></h2><p>There are two different possibilities to upgrade the management host.</p><ol><li>You do a component-wise in-place upgrade of it.</li><li>You deploy a new management host and <code>clusterctl move</code> the resources
over to it from the old one. (Note: Config state in <code>~/CLUSTER_NAME/</code>)</li></ol><p>TODO: Advice when to do what, risks, limitations</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="in-place-upgrade">In-place upgrade<a href="#in-place-upgrade" class="hash-link" aria-label="Direct link to In-place upgrade" title="Direct link to In-place upgrade">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="operating-system">Operating system<a href="#operating-system" class="hash-link" aria-label="Direct link to Operating system" title="Direct link to Operating system">​</a></h4><p>You should keep the host up-to-date with respect to normal operating system
upgrades, so perform your normal <code>sudo apt-get update &amp;&amp; sudo apt-get upgrade</code>.
<code>kubectl</code>, <code>kustomize</code>, <code>yq</code>, <code>lxd</code> and a few other tools are installed as
snaps, so you may want to upgrade these as well: <code>sudo snap refresh</code>.
Default operating system image was changed from Ubuntu 20.04 to Ubuntu 22.04 in R4.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="k8s-cluster-api-provider-git">k8s-cluster-api-provider git<a href="#k8s-cluster-api-provider-git" class="hash-link" aria-label="Direct link to k8s-cluster-api-provider git" title="Direct link to k8s-cluster-api-provider git">​</a></h4><p>The automation is deployed on the management host by cloning <a href="https://github.com/SovereignCloudStack/k8s-cluster-api-provider" target="_blank" rel="noopener noreferrer">the relevant
git repository</a>.
into the <code>k8s-cluster-api-provider</code> directory. Note that the checked out
branch will be the one that has been used when creating the management host
and you might want to change branches from <code>maintained/v3.x</code> to <code>maintained/v4.x</code>
in case of R2 to R3 upgrade, or <code>maintained/v5.x</code> for R3 to R4 upgrade.
Use <code>git branch -rl</code> to see available branches in the k8s-cluster-api-provider
repository.</p><p>You can update the scripts and templates by checking out the relevant branch
<code>main</code>, <code>maintained/v4.x</code> or <code>maintained/v5.x</code> and using a <code>git pull</code> to ensure
the latest content is retrieved. Once you do that, the cluster-management scripts
will be up-to-date. (The <code>~/bin</code> directory in your search <code>PATH</code> is symlinked to the
check-ed out scripts.)</p><p>Note however that the binaries and used templates are NOT automatically updated.
This should not normally result in problems -- when new features are introduced
in the management scripts, they ensure to continue to support older templates.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="updating-cluster-api-and-openstack-cluster-api-provider">Updating cluster-API and openstack cluster-API provider<a href="#updating-cluster-api-and-openstack-cluster-api-provider" class="hash-link" aria-label="Direct link to Updating cluster-API and openstack cluster-API provider" title="Direct link to Updating cluster-API and openstack cluster-API provider">​</a></h4><p>To get the latest version of cluster-API, you can download a new clusterctl
binary from <a href="https://github.com/kubernetes-sigs/cluster-api/releases" target="_blank" rel="noopener noreferrer">https://github.com/kubernetes-sigs/cluster-api/releases</a>,
make it executable <code>chmod +x clusterctl</code> and install it to <code>/usr/local/bin/</code>,
possibly saving the old binary by renaming it. <code>clusterctl version</code> should now
display the current version number (v1.3.5 at the time of this writing).</p><p>You can now issue the command <code>clusterctl upgrade plan</code> and clusterctl will
list the components in your (kind) management cluster that can be upgraded.
Here&#x27;s an example output:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ubuntu@capi-old-mgmtcluster:~ </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">$ clusterctl upgrade plan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Checking cert-manager version</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Cert-Manager will be upgraded from </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;v1.9.1&quot;</span><span class="token plain"> to </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;v1.11.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Checking new release availability</span><span class="token punctuation" style="color:rgb(248, 248, 242)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Latest release available </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">for</span><span class="token plain"> the v1beta1 API Version of Cluster API </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">contract</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain">:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">NAME                       NAMESPACE                           TYPE                     CURRENT VERSION   NEXT VERSION</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">bootstrap-kubeadm          capi-kubeadm-bootstrap-system       BootstrapProvider        v1.2.4            v1.3.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">control-plane-kubeadm      capi-kubeadm-control-plane-system   ControlPlaneProvider     v1.2.4            v1.3.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cluster-api                capi-system                         CoreProvider             v1.2.4            v1.3.5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">infrastructure-openstack   capo-system                         InfrastructureProvider   v0.6.3            v0.7.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">You can now apply the upgrade by executing the following command:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">clusterctl upgrade apply --contract v1beta1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can then upgrade the components. You can do them one-by-one or simply do
<code>clusterctl upgrade apply --contract v1beta1</code></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="new-templates">New templates<a href="#new-templates" class="hash-link" aria-label="Direct link to New templates" title="Direct link to New templates">​</a></h4><p>The <code>cluster-template.yaml</code> template used for the workload clusters is located in
<code>~/k8s-cluster-api-provider/terraform/files/template/</code> and copied from there into
<code>~/cluster-defaults/</code>. Then workload clusters are created, they will also have a
copy of it in <code>~/${CLUSTER_NAME}/</code>. If you have not changed it manually, you can
copy it over the old templates. (Consider backing up the old one though.)</p><p>The next <code>create_cluster.sh &lt;CLUSTER_NAME&gt;</code> run will then use the new template.
Note that <code>create_cluster.sh</code> is idempotent -- it will not perform any changes
on the cluster unless you have changed its configuration by tweaking
<code>cluster-template.yaml</code> (which you almost never do!) or <code>clusterctl.yaml</code>
(which you do often).</p><p>The other template file that changed -- however, some terraform logic is used to
prefill it with values. So you can&#x27;t copy it from git.
Instead for going from R2 to R3, there is just one real change that you want
to apply: Add the variables <code>CONTROL_PLANE_MACHINE_GEN: genc01</code> and
<code>WORKER_MACHINE_GEN: genw01</code> to it. If you have copied over the new
<code>cluster-template.yaml</code> as described above, then you&#x27;re done. Otherwise
you can use the script <code>update-R2-R3.sh &lt;CLUSTER_NAME&gt;</code>
to tweak both <code>clusterctl.yaml</code> and <code>cluster-template.yaml</code> for the
relevant cluster. (You can use <code>cluster-defaults</code> to change the templates
in <code>~/cluster-defaults/</code> which get used when creating new clusters.)</p><p>In the R3 to R4, CALICO_VERSION was moved from <code>.capi-settings</code> to <code>clusterctl.yaml</code>. So
before upgrading workload clusters, you must add it also to the <code>~/${CLUSTER_NAME}/clusterctl.yaml</code>.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;CALICO_VERSION: v3.25.0&quot;</span><span class="token plain"> </span><span class="token operator">&gt;&gt;</span><span class="token plain"> ~/cluster-defaults/clusterctl.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;CALICO_VERSION: v3.25.0&quot;</span><span class="token plain"> </span><span class="token operator">&gt;&gt;</span><span class="token plain"> ~/testcluster/clusterctl.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the R3 to R4 upgrade process, <code>cluster-template.yaml</code> changed etcd defrag process in the
kubeadm control-planes and also security group names by adding <code>${PREFIX}-</code> to them, so it
has to be changed also in openstack project e.g. (<em>PREFIX=capi</em>):</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">openstack security group </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> --name capi-allow-ssh allow-ssh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">openstack security group </span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">set</span><span class="token plain"> --name capi-allow-icmp allow-icmp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We changed immutable fields in the Cluster API templates, so before running
<code>create_cluster.sh</code> to upgrade existing workload cluster the <code>CONTROL_PLANE_MACHINE_GEN</code>
and <code>WORKER_MACHINE_GEN</code> needs to be incremented in cluster specific <code>clusterctl.yaml</code>.</p><p>In the R3 to R4 process, also <code>cloud.conf</code> added <code>enable-ingress-hostname=true</code> to the
LoadBalancer section. It is due to <code>NGINX_INGRESS_PROXY</code> defaulting to true now. So if
you want to use, or you are already using this proxy functionality we recommend you to
add this line to your <code>cloud.conf</code>, e.g.:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;enable-ingress-hostname=true&quot;</span><span class="token plain"> </span><span class="token operator">&gt;&gt;</span><span class="token plain"> ~/cluster-defaults/cloud.conf</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;enable-ingress-hostname=true&quot;</span><span class="token plain"> </span><span class="token operator">&gt;&gt;</span><span class="token plain"> ~/testcluster/cloud.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then, before upgrading workload cluster by <code>create_cluster.sh</code>,
you should delete cloud-config secret in the kube-system namespace, so it can be recreated. E.g.:
<code>kubectl delete secret cloud-config -n kube-system --kubeconfig=testcluster/testcluster.yaml</code></p><p>Also, the default nginx-ingress version has changed, so we recommend before upgrading cluster
to delete ingress-nginx jobs, so new job with new image can be created in the update process.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl delete job ingress-nginx-admission-create -n ingress-nginx --kubeconfig</span><span class="token operator">=</span><span class="token plain">testcluster/testcluster.yaml</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">kubectl delete job ingress-nginx-admission-patch -n ingress-nginx --kubeconfig</span><span class="token operator">=</span><span class="token plain">testcluster/testcluster.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you are curious: In R2, doing rolling upgrades of k8s versions required
edits in <code>cluster-template.yaml</code> -- this is no longer the case in R3 and R4.
Just increase the generation counter for node and control plane nodes if you
upgrade k8s versions -- or otherwise change the worker or control plane
node specs, such as e.g. using a different flavor.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="r4-to-r5">R4 to R5<a href="#r4-to-r5" class="hash-link" aria-label="Direct link to R4 to R5" title="Direct link to R4 to R5">​</a></h5><p>In R4 to R5, the <code>cluster-template.yaml</code> and <code>clusterctl.yaml</code> changed (see release notes).</p><p>You can use script <code>update_R4_to_R5.sh</code> to update the default <code>cluster-template.yaml</code> and <code>clusterctl.yaml</code>.</p><p>Note: !This script is under development and will be stabilized within the release R5!</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">update_R4_to_R5.sh </span><span class="token operator">&lt;</span><span class="token plain">CLUSTER_NAME</span><span class="token operator">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="new-defaults">New defaults<a href="#new-defaults" class="hash-link" aria-label="Direct link to New defaults" title="Direct link to New defaults">​</a></h4><p>You deploy a CNI (calico or cilium), the OpenStack Cloud Controller
Manager (OCCM), the cinder CSI driver to clusters; optionally also a
metrics server (default is true), a nginx ingress controller (also
defaulting to true), the flux2 controller, the cert-manager.
Some of these tools come with binaries that you can use for management
purposes and which get installed on the management host in <code>/usr/local/bin/</code>.</p><p>The scripts that deploy these components into your workload clusters
download the manifests into <code>~/kubernetes-manifests.d/</code> with a version
specific name. If you request a new version, a new download will happen;
already existing versions will not be re-downloaded.</p><p>Most binaries in <code>/usr/local/bin/</code> are not stored under a version-specific
name. You need to rename them to case a re-download of a newer version.
(The reason for not having version specific names is that this would
break scripts from users that assume the unversioned names; the good
news is that most of these binaries have no trouble managing somewhat
older deployments, so you can typically work with the latest binary
tool even if you have a variety of versions deployed into various
clusters.)</p><p>The defaults have changed as follows:</p><table><thead><tr><th></th><th>R2</th><th>R3</th><th>R4</th></tr></thead><tbody><tr><td>kind</td><td>v0.14.0</td><td>v0.14.0</td><td>v0.17.0</td></tr><tr><td>capi</td><td>v1.0.5</td><td>v1.2.2</td><td>v1.3.5</td></tr><tr><td>capo</td><td>v0.5.3</td><td>v0.6.3</td><td>v0.7.1</td></tr><tr><td>helm</td><td>v3.8.1</td><td>v3.9.4</td><td>v3.11.1</td></tr><tr><td>sonobuoy</td><td>v0.56.2</td><td>v0.56.10</td><td>v0.56.16</td></tr><tr><td>calico</td><td>v3.22.1</td><td>v3.24.1</td><td>v3.25.0</td></tr><tr><td>cilium</td><td>unversioned</td><td>unversioned</td><td>v1.13.0</td></tr><tr><td>nginx-ingress</td><td>v1.1.2</td><td>v1.3.0</td><td>v1.6.4</td></tr><tr><td>flux2</td><td>unversioned</td><td>unversioned</td><td>v0.40.2</td></tr><tr><td>cert-manager</td><td>v1.7.1</td><td>v1.9.1</td><td>v1.11.0</td></tr></tbody></table><p>TODO: calico und cilium tooling note</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-clusterctl-move-approach">The clusterctl move approach<a href="#the-clusterctl-move-approach" class="hash-link" aria-label="Direct link to The clusterctl move approach" title="Direct link to The clusterctl move approach">​</a></h3><p>To be written</p><ol><li>Create new management host in same project -- avoid name conflicts
with different prefix, to be tweaked later. Avoid testcluster creation</li><li>Ensure it&#x27;s up and running ...</li><li>Tweak prefix</li><li>Copy over configs (and a bit of state though that&#x27;s uncritical) by using
the directories</li><li>Copy over the openstack credentials clouds.yaml and the kubectl config</li><li>clusterctl move</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="updating-workload-clusters">Updating workload clusters<a href="#updating-workload-clusters" class="hash-link" aria-label="Direct link to Updating workload clusters" title="Direct link to Updating workload clusters">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="k8s-version-upgrade">k8s version upgrade<a href="#k8s-version-upgrade" class="hash-link" aria-label="Direct link to k8s version upgrade" title="Direct link to k8s version upgrade">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="on-r3-and-r4-clusters">On R3 and R4 clusters<a href="#on-r3-and-r4-clusters" class="hash-link" aria-label="Direct link to On R3 and R4 clusters" title="Direct link to On R3 and R4 clusters">​</a></h4><p>Edit <code>~/&lt;CLUSTER_NAME&gt;/clusterctl.yaml</code> and put the wanted version into the
fields <code>KUBERNETES_VERSION</code> and <code>OPENSTACK_IMAGE_NAME</code>. The node image will
be downloaded from <a href="https://minio.services.osism.tech/openstack-k8s-capi-images" target="_blank" rel="noopener noreferrer">https://minio.services.osism.tech/openstack-k8s-capi-images</a>
and registered if needed. (If you have updated the k8s-cluster-api-provider repo,
you can use a version v1.NN.x, where you fill in NN with the wanted k8s version,
but leave a literal <code>.x</code> which will get translated to the newest tested version.)</p><p>In the same file, increase the generation counters for <code>CONTROL_PLANE_MACHINE_GEN</code>
and <code>WORKER_MACHINE_GEN</code>.</p><p>Now do the normal <code>create_cluster.sh &lt;CLUSTER_NAME&gt;</code> and watch cluster-api
replace your worker nodes and doing a rolling upgrade of your control plane.
If you used a 3-node (or 5 or higher) control plane node setup, you will have
uninterrupted access not just to your workloads but also the workload&#x27;s cluster
control plane. Use <code>clusterctl describe cluster &lt;CLUSTER_NAME&gt;</code> or simply
<code>kubectl --context &lt;CLUSTER_NAME&gt;-admin@&lt;CLUSTER_NAME&gt; get nodes -o wide</code>
to watch the progress of this.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="on-r2-clusters">On R2 clusters<a href="#on-r2-clusters" class="hash-link" aria-label="Direct link to On R2 clusters" title="Direct link to On R2 clusters">​</a></h4><p>The old way: Editing cluster-template.yaml. Or better use the
<code>update-R2-to-R3.sh</code> script to convert first.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-versions-for-mandatory-components">New versions for mandatory components<a href="#new-versions-for-mandatory-components" class="hash-link" aria-label="Direct link to New versions for mandatory components" title="Direct link to New versions for mandatory components">​</a></h3><p>OCCM, CNI (calico/cilium), CSI</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-versions-for-optional-components">New versions for optional components<a href="#new-versions-for-optional-components" class="hash-link" aria-label="Direct link to New versions for optional components" title="Direct link to New versions for optional components">​</a></h3><p>nginx, metrics (nothing to do), cert-manager, flux</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="etcd-leader-changes">etcd leader changes<a href="#etcd-leader-changes" class="hash-link" aria-label="Direct link to etcd leader changes" title="Direct link to etcd leader changes">​</a></h3><p>While testing clusters with &gt;= 3 control nodes, we have observed occasional transient
error messages that reported an etcd leader change preventing a command from succeeding.
This could result in a dozen of random failed tests in a sonobuoy conformance run.
(Retrying the commands would let them succeed.)</p><p>Too frequent etcd leader changes are detrimental to your control plane performance and
can lead to transient failures. They are a sign that the infrastructure supporting your
cluster is introducing too high latencies.</p><p>We recommend to deploy the control nodes (which run etcd) on instances with local SSD
storage (which we reflect in the default flavor name) and recommend using flavors with
dedicated cores and that your network does not introduce latencies by significant packet drop.</p><p>We now always use slower heartbeat (250ms) and increase CPU and IO priority which used to be
controlled by <code>ETCD_PRIO_BOOST</code>. This is safe.</p><p>If you build multi-controller clusters and can not use a flavor with low latency local storage
(ideally SSD), you can also work around this with <code>ETCD_UNSAFE_FS</code>. <code>ETCD_UNSAFE_FS</code> is using
<code>barrier=0</code> mount option, which violates filesystem ordering guarantees.
This works around storage latencies, but introduces the risk of inconsistent
filesystem state and inconsistent etcd data in case of an unclean shutdown.
You may be able to live with this risk in a multi-controller etcd setup.
If you don&#x27;t have flavors that fulfill the requirements (low-latency
storage attached), your choice is between a single-controller cluster
(without <code>ETCD_UNSAFE_FS</code>) and a multi-controller cluster with
<code>ETCD_UNSAFE_FS</code>. Neither option is perfect, but we deem the
multi-controller cluster preferable in such a scenario.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/SovereignCloudStack/docs-page/tree/main/docs/03-container/components/k8s-cluster-api-provider/doc/Upgrade-Guide.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/container/components/k8s-cluster-api-provider/doc/LoadBalancer-ExtTrafficLocal"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Why externalTrafficPolicy: local?</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/container/components/k8s-cluster-api-provider/doc/roadmap"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Roadmap</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#scs-k8s-cluster-api-provider-upgrade-guide" class="table-of-contents__link toc-highlight">SCS k8s-cluster-api-provider upgrade guide</a></li><li><a href="#management-host-cluster-vs-workload-clusters" class="table-of-contents__link toc-highlight">Management host (cluster) vs. Workload clusters</a></li><li><a href="#updating-the-management-host" class="table-of-contents__link toc-highlight">Updating the management host</a><ul><li><a href="#in-place-upgrade" class="table-of-contents__link toc-highlight">In-place upgrade</a></li><li><a href="#the-clusterctl-move-approach" class="table-of-contents__link toc-highlight">The clusterctl move approach</a></li></ul></li><li><a href="#updating-workload-clusters" class="table-of-contents__link toc-highlight">Updating workload clusters</a><ul><li><a href="#k8s-version-upgrade" class="table-of-contents__link toc-highlight">k8s version upgrade</a></li><li><a href="#new-versions-for-mandatory-components" class="table-of-contents__link toc-highlight">New versions for mandatory components</a></li><li><a href="#new-versions-for-optional-components" class="table-of-contents__link toc-highlight">New versions for optional components</a></li><li><a href="#etcd-leader-changes" class="table-of-contents__link toc-highlight">etcd leader changes</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">Contribute</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://matrix.to/#/!TiDqlLmEUaXqTemaLc:matrix.org?via=matrix.org" target="_blank" rel="noopener noreferrer" class="footer__link-item">Matrix<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://fosstodon.org/@sovereigncloudstack" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mastodon<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/SovereignCloudStack/docs-page" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Sovereign Cloud Stack, SCS and the logo are registered trademarks of the Open Source Business Alliance e.V. — Other trademarks are property of their respective owners.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.fe345add.js"></script>
<script src="/assets/js/main.150bd3f2.js"></script>
</body>
</html>